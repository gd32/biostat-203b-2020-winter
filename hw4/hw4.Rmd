---
title: "Biostat 203B Homework 4"
author: "George Dewey"
output:
    html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Factors Affecting Length of Stay in Trauma Surgical ICU (TSICU) patients involved in Motor Vehicle Accidents

In my previous assignment (HW2), I noted that there was a noticeable spike in the age distribution of TSICU patients between the ages of 19-25, which I attributed to motor vehicle accidents. The TSICU serves patients with severe traumatic injury, respiratory failure as a consequence of major trauma, systemic organ failure, and critical illness post-surgery. (citation: https://www.ccm.pitt.edu/content/upmc-presbyterian-surgical-trauma-icu).  In this analysis, I will explore factors contributing to length of stay among TSICU patients who were involved in motor vehicle accidents.

Length of ICU stay (in days) will be the primary dependent variable for this analysis. Potential for alternative outcomes is to be determined.

---

## Exploratory Data Analysis

### Connect to PostgresSQL database

#### Load database libraries and the tidyverse frontend:

```{r}
library(DBI)
library(RPostgreSQL)
library(tidyverse)
library(lubridate)
```

### Provide connection information

```{r}
# Load configuration settings
dbdriver <- 'PostgreSQL'
user  <- 'postgres'
password <- 'postgres'
dbname <- 'mimic'
schema <- 'mimiciii'

# Connect to the database using the configuration settings
con <- dbConnect(RPostgreSQL::PostgreSQL(), 
                 dbname = dbname,
                 user = user, 
                 password = password)
# Set the default schema
dbExecute(con, paste("SET search_path TO ", schema, sep = " "))
con
```

List tables in the `mimic` database:

```{r}
dbListTables(con)
```

An example SQL query:

```{r}
q = "SELECT * from icustays as i LIMIT 10"

dbGetQuery(con, q) %>% as_tibble()
```

## Query and subsetting

Using the tables `patients`, `icustays`, `d_icd_diagnoses` we create a cohort of only patients who were first admitted to the TSICU.

```{r}
tbl(con, "transfers") %>%
  select(subject_id, hadm_id, prev_careunit, curr_careunit) %>%
  filter(is.na(prev_careunit) & curr_careunit == "TSICU") %>%
  select(subject_id, hadm_id) %>%
  distinct() %>%
  print() -> ts_admits
```

Now we want to restrict to patients who were involved in motor vehicle accidents. Let's find ICD codes containing **motor vehicle**:

```{r}
tbl(con, "d_icd_diagnoses") %>%
  filter(str_detect(tolower(long_title), "motor vehicle")) %>%
  print()
```

<<<<<<< HEAD
There are over 150 ICD codes involving motor vehicle accidents. On closer inspection, we can see that there are some major categories - about 60 are for non-traffic accidents, while some are sequelae of motor vehicle accidents (for example, E9520 - Suicide and self-inflicted poisoning by motor vehicle gas). I will restrict the cohort only to patients involved in accidents involving a vehicle directly (either traffic or non-traffic). This should include all vehicle types (bicycle, motorcycle, even animal riders).

```{r}
tbl(con, "d_icd_diagnoses") %>%
  filter(str_detect(tolower(long_title), "traffic accident")) %>%
  select(icd9_code, long_title) %>%
  print() -> mv_codes
```

The table `diagnoses_icd` stores the diagnosis for each admission. We use `semi_join()` to keep the rows in `diagnoses_icd` that match the ICD-9 codes we found before:

||||||| merged common ancestors
`diagnoses_icd` table stores the diagnosis of each admission. We use `semi_join()` to keep the rows in `diagnoses_icd` that match the ICD-9 codes related to heart attack:
=======
There are over 150 codes involving motor vehicle accidents. On closer inspection, we can see that there are some major categories - about 60 are for non-traffic accidents, while some are sequelae of motor vehicle accidents (for example, E9520 - Suicide and self-inflicted poisoning by motor vehicle gas). I will restrict the cohort only to patients involved in accidents involving a vehicle directly (either traffic or non-traffic):

```{r}
tbl(con, "d_icd_diagnoses") %>%
  filter(str_detect(tolower(long_title), "traffic accident")) %>%
  select(icd9_code, long_title) %>%
  print() -> icd_codes
```

The table `diagnoses_icd` stores the diagnosis for each admission. We use `semi_join()` to keep the rows in `diagnoses_icd` that match the ICD-9 codes related to heart attack:

>>>>>>> a3d05295d9e75e037a4b101a35b0f7c741693264
```{r}
tbl(con, "diagnoses_icd") %>%
<<<<<<< HEAD
  semi_join(mv_codes, by = "icd9_code") %>%
  print() -> mv_admits
||||||| merged common ancestors
  semi_join(mi_codes, by = "icd9_code") %>%
  print() -> mi_admissions
=======
  semi_join(icd_codes, by = "icd9_code") %>%
  print() -> mv_admits
>>>>>>> a3d05295d9e75e037a4b101a35b0f7c741693264
```

Dr. Zhou previously found that the field `seq_num` represents the priority ranking for the reason for admission. Since motor vehicle accidents may indicate an broad indicator of reason for admission, I will expand the range of `seq_num` to be included in the cohort to 1-10 (compared to the 1-5 range for the example analysis of myocardial infarction).

```{r}
mv_admits %>%
  filter(seq_num <= 10) %>%
  group_by(subject_id, hadm_id) %>%
  filter(min_rank(seq_num) <= 1) %>%
  ungroup() %>%
  select(subject_id, hadm_id, icd9_code, seq_num) %>%
  print() -> mv_admits
```

Now we `inner_join` the table of admissions to CCU and the table of admissions that include our specific vehicle accident-related diagnoses.

```{r}
ts_admits %>%
  inner_join(mv_admits, by = c("subject_id", "hadm_id")) %>%
  print() -> ts_cohort

ts_cohort %>% as_tibble() -> ts_cohort
```

```{r}
head(ts_cohort)
dim(ts_cohort)
```

Our cohort of motor vehicle accident victims is quite small (could be detrimental to a heavily stratified analysis but is a good sign for public health).

From the `admissions` table, obtain the in and out times for each patient so we can calculate length of hospital stay. We can also obtain the length of each ICU stay from the `icustays` table.

```{r}  
tbl(con, "admissions") %>% 
  select(subject_id, hadm_id, admittime, dischtime, hospital_expire_flag, 
         edregtime, edouttime) %>%
  as_tibble -> admits
          
tbl(con, "patients") %>% select(subject_id, dob, dod) %>% as_tibble() -> pts

tbl(con, "icustays") %>% select(subject_id, hadm_id, los) %>% as_tibble -> icu

ts_cohort %>% left_join(pts, by = "subject_id") %>% 
  left_join(icu, by = c("subject_id", "hadm_id")) %>%
  left_join(admits, by = c("subject_id", "hadm_id")) -> ts_cohort

ts_cohort %>% rename(icu_los = los) -> ts_cohort
```

Now that we have some time-based information, let's calculate some summary variables:

  1) Calculate `age` by subtracting the date of birth (`dob`) from the time of admission (`admittime`).
  2) Calculate time in the emergency room `ed_time` by subtracting `edregtime` from `edouttime`.
  3) Calculate time in hospital `hosp_time` by subtracting `admittime` from the time of discharge (`dischtime`).
  
Once we have these columns, we can drop the component variables.

Additionally, from Project 2, remember that patients with ages $\ge$ 90 had their ages masked. For simplicity's sake, let's remove patients aged 90 and over from the cohort.

```{r}
ts_cohort %>%
  mutate(age = as.numeric(admittime - dob, "weeks") / 52.25) %>%
  mutate(ed_time = as.numeric(edouttime - edregtime, "days")) %>%
  mutate(hosp_time = as.numeric(dischtime - admittime, "days")) %>%
  select(-c(admittime, dischtime, edregtime, edouttime, dob, dod)) %>%
  filter(age < 90) -> ts_cohort
```

From the `admissions` and `patients` tables, we can grab some demographics:

```{r}
tbl(con, "admissions") %>%
  select(subject_id, ethnicity) %>%
  distinct() %>%
  print() -> study_subjects
```
```{r}
tbl(con, "patients") %>%
  select(subject_id, gender) %>%
  distinct() %>%
  full_join(study_subjects, by = "subject_id") %>%
  as_tibble -> pt_gender
```
```{r}
study_subjects %>%
  semi_join(ts_cohort, by = "subject_id") %>%
  print() -> study_subjects
```

Let's resolves ome diversity and inconsistency in the `ethnicity` field:

```{r}
unknown_ethnicity <- c(
  "OTHER",
  "UNABLE TO OBTAIN",
  "UNKNOWN/NOT SPECIFIED",
  "MULTI RACE ETHNICITY",
  "PATIENT DECLINED TO ANSWER",
  "UNKNOWN"
)

study_subjects %>%
  collect() %>%
  mutate(ethnic_group = case_when(
    str_detect(ethnicity, "^ASIAN") ~ "ASIAN",
    str_detect(ethnicity, "^BLACK") ~ "BLACK",
    str_detect(ethnicity, "^HISPANIC") ~ "HISPANIC",
    str_detect(ethnicity, "^WHITE") ~ "WHITE",
    ethnicity %in% unknown_ethnicity ~ NA_character_,
    TRUE ~ NA_character_
  )) %>%
  select(subject_id, gender, ethnic_group) %>%
  print() -> study_subjects
```

Some patients are coded as belonging to more than one ethnic group. To resolve these inconsistencies, we define a helper function to pick the modal value from a vector of values in R, which can be used by the `summarize()` function to choose one ethnic group for each patient.
```{r}
most <- function(x) {
  if (all(is.na(x))) return(NA_character_)
  y <- table(x, useNA = "no")
  if (length(which(y == max(y))) > 1) return(NA_character_)
  return(names(y)[which.max(y)])
}

study_subjects %>%
  group_by(subject_id) %>%
  summarize(ethnic_group = most(ethnic_group)) %>%
  ungroup() %>%
  mutate(ethnic_group = ifelse(is.na(ethnic_group), "UNKNOWN", ethnic_group)) %>%
  print() -> subject_ethnic_groups
```
```{r}
study_subjects %>%
  select(subject_id, gender) %>%
  left_join(subject_ethnic_groups, by = "subject_id") %>%
  print() -> study_subjects
```
Now we add the demographic information `gender` and `ethnicity` into our `study_admissions` table:
```{r}
study_admissions %>%
  left_join(study_subjects, by = "subject_id", copy = TRUE) %>%
  print() -> study_admissions
```

## Close the connection to a database

Close the connection:
```{r}
dbDisconnect(con)
```

## CONSORT Flow Diagrams

CONSORT Flow Diagrams can be used to plot the flow of data selection of a patient cohort.   
For more details, see:
[The CONSORT Flow Diagram](http://www.consort-statement.org/consort-statement/flow-diagram). Following code shows an example. 

```{r plot}
library(shape)
library(diagram)

# set margins and multiplot
par(mfrow = c(1, 1))
par(mar = c(0, 0, 0, 0))

# initialise a plot device
openplotmat()

# position of boxes
# 1st column indicates x axis position between 0 and 1
# 2nd column indicates y axis position between 0 and 1
# automatically assigns vertical position
num_of_boxes <- 6
auto_coords = coordinates(num_of_boxes)
vert_pos = rev(auto_coords[,1])
box_pos <- matrix(nrow = num_of_boxes, ncol = 2, data = 0)
box_pos[1,] = c(0.20, vert_pos[1]) # 1st box
box_pos[2,] = c(0.70, vert_pos[2]) # 2nd box
box_pos[3,] = c(0.70, vert_pos[3]) # 3rd box
box_pos[4,] = c(0.70, vert_pos[4]) # etc...
box_pos[5,] = c(0.70, vert_pos[5])
box_pos[6,] = c(0.20, vert_pos[6])

# content of boxes
box_content <- matrix(nrow = num_of_boxes, ncol = 1, data = 0)
box_content[1] = "All patients in MIMIC-III \n n = 58,976" # 1st box
box_content[2] = "Exclude patients of age < 18 \n n = 8,180" # 2nd box
box_content[3] = "Exclude patients with no ICU admissions \n n = 1,071" # 3rd box
box_content[4] = "Exclude patients with diabetes \n n = 1,324" # etc...
box_content[5] = "Exclude patients with sepsis \n n = 4,804"
box_content[6] = "Study cohort \n n = 43,597"

# adjust the size of boxes to fit content
box_x <- c(0.20, 0.25, 0.25, 0.25, 0.25, 0.20)
box_y <- c(0.07, 0.07, 0.07, 0.07, 0.07, 0.07)

# Draw the arrows
straightarrow(from = c(box_pos[1,1],box_pos[2,2]), to = box_pos[2,], lwd = 1)  
straightarrow(from = c(box_pos[1,1],box_pos[3,2]), to = box_pos[3,], lwd = 1)  
straightarrow(from = c(box_pos[1,1],box_pos[4,2]), to = box_pos[4,], lwd = 1)  
straightarrow(from = c(box_pos[1,1],box_pos[5,2]), to = box_pos[5,], lwd = 1)  
straightarrow(from = box_pos[1,], to = box_pos[6,], lwd = 1)

# Draw the boxes
for (i in 1:num_of_boxes) {
  textrect(mid = box_pos[i,], radx = box_x[i], rady = box_y[i], 
           lab = box_content[i], 
           shadow.col = "grey")
  }
```

## Install PostgreSQL and `RpostgreSQL` package on CentOS

This is a note to myself (Dr. Hua Zhou). The postgres in yum is an old version. We want to install the most recent postgres and then build the `RpostgreSQL` package based on it. 

1. Follow instructions in <https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7> to install PostgreSQL 11 on CentOS 7. 

2. Issue following command to install `RPostgreSQL` in R:
```{bash, eval = F}
sudo R -e 'Sys.setenv(PG_INCDIR="/usr/pgsql-11/include/"); Sys.setenv(PG_LIBDIR="/usr/pgsql-11/lib/"); install.packages("RPostgreSQL")'
```
