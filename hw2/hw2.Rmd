---
title: "HW2 Solutions"
author: 
- "George Dewey"
- "UID: 704528320"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries

```{r echo=T, results = 'hide'}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(gridExtra)
library(grid)
library(stringr)
library(magrittr)
```

# Show session info

```{r}
sessionInfo()
```

# Question 1 - Demographic Information of Admissions

## Load data

```{r}
admits = read_csv("/home/203bdata/mimic-iii/ADMISSIONS.csv")
```

## Change column names

```{r}
col_names = c(
  'rowid',
  'sub_id',
  'hadm_id',
  'admit_time',
  'disch_time',
  'death_time',
  'admit_type',
  'admit_location',
  'disch_location',
  'insurance',
  'language',
  'religion',
  'mar_stat',
  'ethnicity',
  'ed_reg_time',
  'ed_out_time',
  'diagnosis',
  'hospital_exp_flag',
  'has_chart_events'
)

names(admits) = col_names
```

I converted all column names to lowercase and renamed some for readability.

## Parse out year/month/day from datetime columns

```{r}
admits = admits %>% mutate(
  admit_year = year(admit_time),
  admit_month = month(admit_time, label = T),
  admit_day = day(admit_time)
)

select(admits, starts_with("admit"))
```

We can see that there are individual columns for admit year, admit month, and admit day.

# Plotting

## Admission year

```{r, cache = T}
summary(admits$admit_year)

ggplot(admits) +
  geom_boxplot(aes(x = "", y = admit_year), color = "navy") +
  xlab("") +
  ylab("Admission Year") +
  theme(axis.ticks = element_blank()) +
  ggtitle("Boxplot of Admission Year")

ggplot(admits) +
  geom_bar(mapping = aes(x = admit_year), fill = "navy") +
  xlab("Admission Year") +
  ylab("Count") +
  ggtitle("Frequency of Admissions by Year")
```

Overall, the distribution of admissions by year appears fairly uniform. Some exceptions include a noticeable peak around 2135 and a noticeable dropoff after 2200 - perhaps a data sourcing issue.

## Admission month

```{r, cache = T}
ggplot(admits) +
  geom_bar(aes(x = admit_month), fill = "navy") +
  xlab("Admission Month") +
  ylab("Count") +
  ggtitle("Frequency of Admissions by Month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Not much of a pattern to report here, but February appears to be the moth with the lowest number of admissions while August seemed to be the month with the most admissions.

## Admission day

```{r, cache = T}
admits = admits %>% mutate(admit_wday = wday(admit_time, label = T))

ggplot(admits) +
  geom_bar(aes(x = admit_wday), fill = "navy") +
  xlab("Admission Day") +
  ylab("Count") +
  ggtitle("Frequency of Admissions by Day of Week") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Most admissions happen on Monday, after the low admission period of the weekend (Sat/Sun). There is also a distinct decrease in admission counts through the week.


## Admission hour

```{r, cache = T}
admits = admits %>% mutate(admit_hour = hour(admit_time))

ggplot(admits) +
  geom_bar(aes(x = admit_hour), fill = "navy") +
  scale_x_continuous(breaks = c(0, 4, 8, 12, 16, 20)) +
  scale_y_continuous(expand = c(0, 0),
                     limits = c(0, 5000)) +
  xlab("Admission Hour") +
  ylab("Count") +
  ggtitle("Frequency of Admissions by Hour")
```

Admits are noticeably lower during the early morning hours (0-6 AM). There is a large peak at 7am, most likely because regular hospital staff come to work at that point and begin to process admissions. Admissions seem to peak outside of the opening rush between 4pm and 6pm.

## Duration of Stay

```{r, cache = T}
admits = admits %>% 
         mutate(days_of_stay = as.numeric((disch_time - admit_time), "days"))

ggplot(admits) +
  geom_histogram(aes(days_of_stay), fill = "navy", binwidth = 5) +
  xlab("Length of Stay (Days)") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Length of Stay (Days)")

mean(admits$days_of_stay)

median(admits$days_of_stay)
```

Almost all admissions were less than 100 days. We can see that the mean admission duration was around 10 days and the median was about 6.5 days.

## Admission type

```{r, cache = T}
ggplot(admits) +
  geom_bar(aes(admit_type), fill = "navy") +
  xlab("Admit Type") +
  ylab("Count") +
  ggtitle("Frequency of Admissions by Admit Type")
```

A majority of admissions were emergency-based. Elective and newborn/pregnancy-related admissions were about even in frequency.

## Number of admissions per patient

```{r, cache = T}
ggplot() +
  geom_bar(aes(table(admits$sub_id)), fill = "navy") +
  xlab("Number of admissions per patient") +
  ylab("Count") +
  ggtitle("Number of Admissions per Patient")

admit_count_table = as.data.frame(table(admits$sub_id))

head(admit_count_table[order(-admit_count_table$Freq), ])

max(admit_count_table$Freq)
```

While a great majority of patients were only admitted once in the dataset, we can see that some patients were admitted more than 20 times, with one patient being admitted 42 times.

## Admissions location

```{r, cache = T}

admits %>% group_by(admit_location) %>% filter(n() > 500) %>%
  ggplot() +
  geom_bar(aes(admit_location), fill = "navy") +
  xlab("Admission Location") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Location") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

For readibility, 3 categories of admission location with cell counts < 500 were excluded: No info, hmo/referral sick, and skilled nursing transfer. Like we saw previously, most admissions are emergency room-based.

## Insurance

```{r, cache = T}
ggplot(admits) +
  geom_bar(aes(insurance), fill = "navy") +
  xlab("Insurance Type") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Insurance Type")
```

Patients with Medicare and those using private insurance represent the most admissions, as expected of a US-based patient base.

## Language

```{r}
admit_unique = admits %>% group_by(sub_id) %>% filter(n() == 1)
```

First, create a dataset with only unique patients (i.e. only one admit per person).

```{r, echo = T}
admit_unique %>% group_by(language) %>% filter(n() > 5) %>%
  ggplot() +
  geom_bar(aes(language), fill = "navy") +
  xlab("Language") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Language") +
  theme(axis.text.x = element_text(
    size = 5,
    angle = 90,
    hjust = 1
  ))
```

First, we examine languages with cell counts > 5. As expected, a vast majority of patients who reported their language of choice chose English; more patients actually did not report a language at all. Let's exclude those groups and inspect further:

```{r, echo = T}
admit_unique %>% group_by(language) %>% filter(n() > 25 && n() < 5000) %>%
  ggplot() +
  geom_bar(aes(language), fill = "navy") +
  xlab("Language") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Language (Non-English)") +
  theme(axis.text.x = element_text(
    size = 5,
    angle = 90,
    hjust = 1
  ))
```

We now exclude cell counts less than 25 to visualize the most common non-English languages. Spanish was the most common at over 600 cases, with Pashtun, Russian, and Cantonese rounding out the top 5.

## Religion

```{r, cache = T}
admit_unique %>% group_by(religion) %>%
  ggplot() +
  geom_bar(aes(religion), fill = "navy") +
  xlab("Religion") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Religion") +
  theme(axis.text.x = element_text(
    size = 10,
    angle = 90,
    hjust = 1
  ))
```

Like in our exploration of language, several religions appear much more frequently than others (Catholic, Jewish) and many patients did not report a religion (unobtainable, not specified). Let's look at the minor categories:

```{r, cache = T}
admit_unique %>% group_by(religion) %>% filter(n() < 1000) %>%
  ggplot() +
  geom_bar(aes(religion), fill = "navy") +
  xlab("Religion") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Religion (Minor Categories)") +
  theme(axis.text.x = element_text(
    size = 10,
    angle = 90,
    hjust = 1
  ))
```

Episcopalians and agnostic/atheists are the most common in the minor categories.

## Marital Status

```{r}
admits %>% group_by(sub_id) %>% filter(n() == 1) %>%
  ggplot() +
  geom_bar(aes(mar_stat), fill = "navy") +
  xlab("Marital Status") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Marital Status") +
  theme(axis.text.x = element_text(
    size = 10,
    angle = 90,
    hjust = 1
  ))
```

Most admits were married; single and widowed where the next most frequent categories.

## Ethnicity

```{r}
admit_unique %>% group_by(ethnicity) %>%
  ggplot() +
  geom_bar(aes(ethnicity), fill = "navy") +
  xlab("Ethnicity") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Ethnicity") +
  theme(axis.text.x = element_text(
    size = 5,
    angle = 90,
    hjust = 1
  ))
```

A large majority of the admitted patients where white; the next largest category is African Americans. Let's look at all other ethnicities:


```{r}
admit_unique %>% group_by(ethnicity) %>% filter(n() < 200) %>%
  ggplot() +
  geom_bar(aes(ethnicity), fill = "navy") +
  xlab("Ethnicity") +
  ylab("Count") +
  ggtitle("Frequency of Admission by Ethnicity (non-White)") +
  theme(axis.text.x = element_text(
    size = 5,
    angle = 90,
    hjust = 1
  ))
```

Chinese patients were the most frequent ethnicity when excluding Whites, with Cape Verdians and Puerto Ricans being the next most reported. Note: The threshold of cell counts was set at 200 because between Whites/African Americans and these other groups, the only categories to appear are 'Declined to Answer' and 'Unknown'.

## Death

```{r, cache = T}
admits = admits %>% mutate(survived = is.na(death_time))

ggplot(admits) +
  geom_bar(aes(survived, ..prop.., group = 1), fill = "navy") +
  xlab("Survival Status") +
  ylab("Proportion") +
  ggtitle("Admissions by Survival Status") +
  scale_x_discrete(labels = c("Died", "Survived")) +
  theme(axis.text.x = element_text(
    size = 10,
    angle = 45,
    hjust = 1
  ))
```

Around 10% of admitted patients died.

---

# Question 2

## Load patient data

```{r}
patients = read_csv("/home/203bdata/mimic-iii/PATIENTS.csv")

pt_colnames = c("row_id",
                "sub_id",
                "gender",
                "dob",
                "dod",
                "dod_hosp",
                "dod_ssn",
                "exp_flag")

names(patients) = pt_colnames
```

## Merge patient info with admission data

```{r}
admit_pts = left_join(admits, patients, by = "sub_id")
```

```{r, cache = T}
ggplot(admit_pts) +
  geom_bar(aes(x = gender, y = ..prop.., group = 1), fill = "navy") +
  xlab("Gender") +
  ylab("Proportion") +
  scale_x_discrete(labels = c("Female", "Male")) +
  ggtitle("Distribution of Gender in Admitted Patients") +
  theme(axis.text.x = element_text(
    size = 10,
    angle = 45,
    hjust = 1
  ))
```
Around 45% of admitted patients were female (and thus around 55% were male).

## Age at Admission

### Create age at admission in years

```{r}
admit_pts = admit_pts %>%
  mutate(admit_age = as.numeric(admit_time - dob, "weeks") / 52.25)
```

In the documentation, we find that ages above 89 were modified. Based on a plot of age with no modification, the discrepancy is obvious:

```{r}
ggplot(admit_pts) +
  geom_histogram(aes(admit_age), fill = "navy", binwidth = 10) +
  xlab("Age at Admission") +
  ylab("Count") +
  ggtitle("Distribution of Age at Admission")
```

Now we show two plots, one for ages 0-89, and one for ages over 89. Since it is unclear exactly how age was modified in patients whose age was greater than 89, I have retained the age modification institued by the original publishers (i.e. all ages are above 300).

```{r}
age1 = admit_pts %>% filter(admit_age <= 89) %>%
        ggplot() +
        geom_histogram(aes(admit_age), fill = "navy", binwidth = 5) +
        xlab("Age at Admission") +
        ylab("Count") +
        scale_x_continuous(breaks = seq(0, 90, 10)) +
        ggtitle("Ages 0-89")

age2 = admit_pts %>% filter(admit_age > 89) %>%
        ggplot() +
        geom_histogram(aes(admit_age - 210), fill = "navy", binwidth = 2) +
        xlab("Age at Admission") +
        ylab("Count") +
        scale_x_continuous(breaks = seq(90, 102, 2)) +
        ggtitle("Ages 89+")


grid.arrange(age1, 
             age2, 
             nrow = 1, 
             top = textGrob("Age Distribution of Admitted Patients", 
             gp = gpar(fontsize = 20, font = 2)))
```

We can see a noticeable block of admissions at age 0 (probably newborns who must be admitted after birth). As expect, admission count increases with age, decreasing past age 90 (likely due to low sample size of old patients).





